<extend name="$_admin_public_layout"/>
<block name="style">
    <style type="text/css">
        .form-control[disabled], fieldset[disabled] .form-control {
            cursor: auto;
        }
        td.operate {
            text-align: center;
        }
        td .add-row {
            color: #333;
            margin-right: 10px;
        }
        td .del-row {
            text-align: right;
            color: #333;
        }
    </style>
</block>
<block name="main">
    <div id="main" class="col-xs-12 col-sm-10 main" style="overflow-y: scroll;">
        <!-- 面包屑导航 -->
        <ul class="breadcrumb">
            <li><i class="fa fa-map-marker"></i></li>
            <li class="text-muted">供应商管理</li><li class="text-muted">供应商详情</li><li class="text-muted">编辑供应商</li>
        </ul>

        <!-- 主体内容区域 -->
        <div class="tab-content ct-tab-content">

            <div class="builder listbuilder-box panel-body">
                <!-- Tab导航 -->

                <!-- 数据列表 -->
                <div class="builder-container">
                    <div class="row">
                        <div class="col-xs-12">
                            <form id="supplier" action="" method="post" class="form-horizontal" data-id="{$supplier.id}">
                                <div class="form-group ">
                                    <label class="col-sm-2 col-lg-1 control-label">名字</label>
                                    <div class="col-sm-8 col-lg-7">
                                        <input type="text" class="form-control" name="name" value="{$supplier.name}">
                                    </div>
                                </div>
                                <div class="form-group ">
                                    <label class="col-sm-2 col-lg-1 control-label">分组</label>
                                    <div class="col-sm-8 col-lg-7">
                                        <select name="group" class="form-control">
                                            <option value="">请选择：</option>
                                            <foreach name="supplierGroup" item="vo">
                                                <switch name="vo.id">
                                                    <case value="$supplier.group.id">
                                                        <option value="{$vo.id}" selected="selected">{$vo.name}</option>
                                                    </case>
                                                    <default />
                                                        <option value="{$vo.id}">{$vo.name}</option>
                                                </switch>
                                            </foreach>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group ">
                                    <label class="col-sm-2 col-lg-1 control-label">电话</label>
                                    <div class="col-sm-8 col-lg-7">
                                        <input type="text" class="form-control" name="tel" value="{$supplier.tel}">
                                    </div>
                                </div>
                                <div class="form-group ">
                                    <label class="col-sm-2 col-lg-1 control-label">地址</label>
                                    <div class="col-sm-8 col-lg-7">
                                        <input type="text" class="form-control" name="address" value="{$supplier.address}">
                                    </div>
                                </div>
                                <div class="form-group ">
                                    <label class="col-sm-2 col-lg-1 control-label">创建时间</label>
                                    <div class="col-sm-8 col-lg-7">
                                        <input disabled type="text" class="form-control" value="{$supplier.create_time}">
                                    </div>
                                </div>
                                <div class="form-group ">
                                    <label class="col-sm-2 col-lg-1 control-label">更新时间</label>
                                    <div class="col-sm-8 col-lg-7">
                                        <input disabled type="text" class="form-control" value="{$supplier.update_time}">
                                    </div>
                                </div>
                                <div class="form-group ">
                                    <label class="col-sm-2 col-lg-1 control-label">备注</label>
                                    <div class="col-sm-8 col-lg-7">
                                        <input type="text" class="form-control" name="note" value="{$supplier.note}">
                                    </div>
                                </div>

                            </form>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-10 col-lg-8">
                            <h4>供应商联系人列表：</h4>
                            <div class="builder-table">
                                <div class="panel panel-default table-responsive">
                                    <table id="linkman" class="table table-bordered table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>联系人</th>
                                                <th>手机</th><th>电话</th>
                                                <th>邮箱</th><th>QQ</th>
                                                <th>备注</th><th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        <foreach name="supplier.linkman" item="vo">
                                            <tr data-id="{$vo.id}">
                                                <td contenteditable="true" name="name">{$vo.name}</td>
                                                <td contenteditable="true" name="mobile">{$vo.mobile}</td>
                                                <td contenteditable="true" name="tel">{$vo.tel}</td>
                                                <td contenteditable="true" name="email">{$vo.email}</td>
                                                <td contenteditable="true" name="qq">{$vo.qq}</td>
                                                <td contenteditable="true" name="note">{$vo.note}</td>
                                                <td class="operate"><a class="add-row" title="添加一行" href="javascript:;"><i class="fa fa-plus"></i></a><a title="删除当前行" class="del-row" href="javascript:;"><i class="fa fa-trash-o"></i></a></td>
                                            </tr>
                                        </foreach>
                                        <empty name="supplier.linkman">
                                            <tr>
                                                <td contenteditable="true" name="name"></td>
                                                <td contenteditable="true" name="mobile"></td>
                                                <td contenteditable="true" name="tel"></td>
                                                <td contenteditable="true" name="email"></td>
                                                <td contenteditable="true" name="qq"></td>
                                                <td contenteditable="true" name="note"></td>
                                                <td class="operate"><a class="add-row" title="添加一行" href="javascript:;"><i class="fa fa-plus"></i></a><a title="删除该联系人" class="del-row" href="javascript:;"><i class="fa fa-trash-o"></i></a></td>
                                            </tr>
                                        </empty>
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- 顶部工具栏按钮 -->
                <div class="builder-toolbar">
                    <div class="row">
                        <!-- 工具栏按钮 -->
                        <div class="col-xs-12 col-sm-9 button-list clearfix">
                            <div class="form-group">
                                <div class="col-sm-offset-2 col-lg-offset-1 col-sm-10">
                                    <button type="button" id="save" class="btn btn-primary">保存</button>
                                    <button type="button" class="btn btn-danger" onclick="history.back();">返回</button>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>

                <!-- 额外功能代码 -->
            </div>

        </div>

    </div>
</block>
<block name="script">
    <script type="text/javascript">
        $(window).ready(function (e) {

            function getFormData() {
                var supplier = new Object();
                supplier.id = $('form').attr('data-id');
                supplier.name= $('[name="name"]').val();
                supplier.supplier_group_id= $('[name="group"]').val();
                supplier.tel = $('[name="tel"]').val();
                supplier.address = $('[name="address"]').val();
                supplier.note = $('[name="note"]').val();
                return supplier;
            }

            function getTableData() {
                var table = $('#linkman').get(0);
                var linkmanList = new Array();
                var linkman = null;
                for(var i=1; i<table.rows.length; i++) {
                    linkman = new Object();
                    linkman['id'] = $(table.rows[i]).attr('data-id');
                    linkman['name'] = table.rows[i].cells[0].innerText;
                    linkman['supplier_id'] = $('form').attr('data-id');
                    linkman['mobile'] = table.rows[i].cells[1].innerText;
                    linkman['tel'] = table.rows[i].cells[2].innerText;
                    linkman['email'] = table.rows[i].cells[3].innerText;
                    linkman['qq'] = table.rows[i].cells[4].innerText;
                    linkman['note'] = table.rows[i].cells[5].innerText;
                    linkmanList.push(linkman);
                }
                return linkmanList;
            }

            function checkForm() {
                var checkStr = '';
                $('#supplier').find('input[name]').each(function () {
                    var key = $(this).attr('name');
                    var value = $(this).val();
                    if (key == 'name' && !value) {
                        checkStr = '供应商名字不能为空！';
                        return false;
                    }
                    if (key == 'tel' && !value) {
                        checkStr = '供应商电话不能为空！';
                        return false;
                    }
                });
                return checkStr;
            }

            function checkTable() {
                var checkStr = '';
                $('#linkman').find('td[name]').each(function() {
                    var key = $(this).attr('name');
                    var value = $(this).html();
                    if (key == 'name' && !value) {
                        checkStr = '联系人姓名不能为空！';
                        return false;
                    }
                    if (key == 'mobile' && !value) {
                        checkStr = '联系人手机号码不能为空！';
                        return false;
                    }
                });
                return checkStr;
            }

            $('#save').on('click', function() {

                /*if (!checkForm() || !checkTable()) {
                    return;
                }*/
                var checkStr = checkForm() || checkTable();
                if (checkStr) {
                    $.alertMessager(checkStr, 'danger');
                    return;
                }

                var linkmanList = getTableData();
                var supplier = getFormData();
                console.log(supplier);
                console.log(linkmanList);
                $.post("{:U('Supplier/supplierEdit')}", {supplier: supplier, linkmanList: linkmanList}, function(data) {
                    console.log(data);
                    if (!data.status) {
                        $.alertMessager('修改失败', 'danger');
                    } else {
                        $.alertMessager('修改成功', 'success');
                        window.setTimeout(function() {
                            window.location = "{:U('Supplier/index')}";
                        }, 2000);
                    }
                });
            })

            $('#linkman').on('click', '.add-row', function() {
                var html = '<tr>\
                <td contenteditable="true" name="name"></td>\
                <td contenteditable="true" name="mobile"></td>\
                <td contenteditable="true" name="tel"></td>\
                <td contenteditable="true" name="email"></td>\
                <td contenteditable="true" name="qq"></td>\
                <td contenteditable="true" name="note"></td>\
                <td class="operate"><a class="add-row" title="添加一行" href="javascript:;"><i class="fa fa-plus"></i></a><a title="删除当前行" class="del-row" href="javascript:;"><i class="fa fa-trash-o"></i></a></td>\
                    </tr>';
                $(this).parents('tr').after(html);
            })

            $('#linkman').on('click', '.del-row', function() {
                var num = $(this).parents('#linkman').find('tr').length;
                if (num === 2) {
                    alert('必须保留一行');
                    return;
                }
                var tr = $(this).parents('tr');
                var id = tr.attr('data-id');
                if (!id) {
                    tr.remove();
                } else {
                    var result = confirm('确定要删除当前联系人？');
                    if (result) {
                        $.post("{:U('Supplier/linkmanDel')}", { id: id }, function(data) {
                            if (data.status) {
                                tr.remove();
                            } else {
                                alert('删除失败');
                            }
                        });
                    }
                }

            })
        });
    </script>
</block>